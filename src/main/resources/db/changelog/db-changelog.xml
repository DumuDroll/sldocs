<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
		http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="initialTables" author="dkorkhovyi">
        <sqlFile path="db/changelog/tables/main-tables.sql"/>
    </changeSet>

    <changeSet id="adminAccount" author="dkorkhovyi" runAlways="true">
        <sqlFile path="db/changelog/tables/admin-account.sql"/>
    </changeSet>

    <changeSet id="2023/01/26_1" author="dddd">
        <createTable tableName="creation_metric">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="professor_number" type="int"/>
            <column name="time_to_form" type="double"/>
        </createTable>
    </changeSet>

    <changeSet id="2023/02/04_1" author="dddd">
        <renameTable oldTableName="curriculum" newTableName="studyload_row"/>
        <renameTable oldTableName="curriculum_discipline" newTableName="studyload_row_discipline"/>
        <renameTable oldTableName="curriculum_professor" newTableName="studyload_row_professor"/>
    </changeSet>

    <changeSet id="2023/02/04_2" author="dddd">
        <renameTable oldTableName="professor" newTableName="teacher"/>
        <renameTable oldTableName="studyload_row_professor" newTableName="studyload_row_teacher"/>
        <renameColumn columnDataType="int" tableName="creation_metric" oldColumnName="professor_number"
                      newColumnName="teacher_number"/>
        <dropColumn tableName="studyload_row" columnName="consult_hours"/>
    </changeSet>

    <changeSet id="2023/02/05_1" author="dddd">
        <dropTable tableName="studyload_row_teacher"/>
        <dropTable tableName="studyload_row_discipline"/>
        <addColumn tableName="studyload_row">
            <column name="discipline_id" type="bigint"/>
            <column name="teacher_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="studyload_row" baseColumnNames="discipline_id"
                                 constraintName="discipline_id_fk"
                                 referencedTableName="discipline"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="studyload_row" baseColumnNames="teacher_id"
                                 constraintName="teacher_id_fk" referencedTableName="teacher"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="2023/02/05_2" author="dddd">
        <createView viewName="eas_vm" replaceIfExists="true">
            select `s`.`id`                  as `id`,
                   `s`.`semester`            as `csem`,
                   `s`.`course`              as `ccor`,
                   `d`.`name`                as `dname`,
                   `s`.`group_names`         as `group_names`,
                   `s`.`lec_hours`           as `lec_hours`,
                   `s`.`lab_hours`           as `lab_hours`,
                   `t`.`name`                as `pname`,
                   `s`.`pract_hours`         as `pract_hours`,
                   `s`.`note`                as `note`,
                   `s`.`number_of_subgroups` as `number_of_subgroups`,
                   `s`.`year`                as `year`
            from ((`discipline` `d`
                join `studyload_row` `s` on
                ((`d`.`id` = `s`.`discipline_id`)))
                join `teacher` `t` on
                ((`t`.`id` = `s`.`teacher_id`)))
                order by `d`.`name`,
                char_length(`s`.`group_names`);
        </createView>
        <createView viewName="psl_vm" replaceIfExists="true">
            select `s`.`id`                  as `id`,
                   `s`.`year`                as `year`,
                   `s`.`course`              as `course`,
                   `s`.`semester`            as `csem`,
                   `s`.`number_of_subgroups` as `number_of_subgroups`,
                   `s`.`students_number`     as `students_number`,
                   `s`.`group_names`         as `group_names`,
                   `s`.`lec_hours`           as `lec_hours`,
                   `s`.`consults_hours`      as `consult_hours`,
                   `s`.`lab_hours`           as `lab_hours`,
                   `s`.`pract_hours`         as `pract_hours`,
                   `s`.`ind_task_hours`      as `ind_task_hours`,
                   `s`.`cp_hours`            as `cp_hours`,
                   `s`.`zalik_hours`         as `zalik_hours`,
                   `s`.`exam_hours`          as `exam_hours`,
                   `s`.`diploma_hours`       as `diploma_hours`,
                   `s`.`dec_cell`            as `dec_cell`,
                   `s`.`ndrs`                as `ndrs`,
                   `s`.`practice`            as `practice`,
                   `s`.`aspirant_hours`      as `aspirant_hours`,
                   `dep`.`name`              as `dep_name`,
                   `s`.`other_forms_hours`   as `other_forms_hours`,
                   `t`.`name`                as `pname`,
                   `d`.`name`                as `dname`,
                   `f`.`name`                as `fac_name`,
                   `t`.`nauk_stupin`         as `nauk_stupin`,
                   `t`.`posada`              as `posada`,
                   `t`.`vch_zvana`           as `vch_zvana`,
                   `t`.`stavka`              as `stavka`
            from ((((`teacher` `t`
                join `studyload_row` `s` on
                ((`t`.`id` = `s`.`teacher_id`)))
                join `discipline` `d` on
                ((`d`.`id` = `s`.`discipline_id`)))
                join `department` `dep` on
                ((`dep`.`id` = `s`.`department_id`)))
                join `faculty` `f` on
                ((`dep`.`faculty_id` = `f`.`id`)))
                order by `d`.`name`,
                char_length(`s`.`group_names`);
        </createView>
    </changeSet>

    <changeSet id="2023/02/08-1" author="dddd">
        <dropForeignKeyConstraint baseTableName="studyload_row" constraintName="FK6myxkmo0upbbkh7fnds3jb67v"/>
        <dropForeignKeyConstraint baseTableName="studyload_row" constraintName="FKcb91o408ic3xbtaddeqyi7rfi"/>
        <dropForeignKeyConstraint baseTableName="department" constraintName="FKj2xhv1clx0m0axk2y53wm4hgl"/>
        <dropTable tableName="faculty"/>
        <dropTable tableName="specialty"/>
        <dropTable tableName="department"/>
        <createTable tableName="formulary">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="folder_name" type="varchar(255)"/>
            <column name="file_name" type="varchar(255)"/>
            <column name="eas_filename" type="varchar(255)"/>
            <column name="psl_filename" type="varchar(255)"/>
            <column name="ind_plan_zip_filename" type="varchar(255)"/>
            <column name="department_short_name" type="varchar(255)"/>
            <column name="department_full_name_genitive_case" type="varchar(255)"/>
            <column name="department_full_name_nominative_case" type="varchar(255)"/>
            <column name="academic_year" type="varchar(255)"/>
            <column name="department_head_tittle" type="varchar(255)"/>
            <column name="department_head_position_name" type="varchar(255)"/>
            <column name="department_head_full_name" type="varchar(255)"/>
            <column name="institute" type="varchar(255)"/>
            <column name="protocol_number" type="varchar(255)"/>
            <column name="protocol_date" type="varchar(255)"/>
            <column name="approved_by_tittle" type="varchar(255)"/>
            <column name="approved_by_position" type="varchar(255)"/>
            <column name="approved_by_full_name" type="varchar(255)"/>
        </createTable>
        <createTable tableName="teacher_hours">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ip_filename" type="varchar(255)"/>
            <column name="bach_num" type="varchar(255)"/>
            <column name="fifth_course_num" type="varchar(255)"/>
            <column name="master_prof_num" type="varchar(255)"/>
            <column name="master_sc_num" type="varchar(255)"/>
            <column name="autumn_sum_fact" type="varchar(255)"/>
            <column name="autumn_sum_plan" type="varchar(255)"/>
            <column name="autumn_sum_row_number" type="varchar(255)"/>
            <column name="spring_sum_fact" type="varchar(255)"/>
            <column name="spring_sum_plan" type="varchar(255)"/>
            <column name="spring_sum_row_number" type="varchar(255)"/>
        </createTable>
        <dropColumn tableName="teacher" columnName="ip_filename"/>
        <dropColumn tableName="teacher" columnName="bach_num"/>
        <dropColumn tableName="teacher" columnName="fifth_course_num"/>
        <dropColumn tableName="teacher" columnName="master_prof_num"/>
        <dropColumn tableName="teacher" columnName="master_sc_num"/>
        <dropColumn tableName="teacher" columnName="asp_num"/>
        <dropColumn tableName="teacher" columnName="autumn_asp"/>
        <dropColumn tableName="teacher" columnName="spring_asp"/>
        <dropColumn tableName="studyload_row" columnName="department_id"/>
        <dropColumn tableName="studyload_row" columnName="specialty_id"/>
        <addColumn tableName="studyload_row">
            <column name="formulary_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="teacher">
            <column name="teacher_hours_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint constraintName="fk_studyload_row2formulary"
                                 baseTableName="studyload_row"
                                 baseColumnNames="formulary_id"
                                 referencedTableName="formulary"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint constraintName="fk_teacher2teacher_hours"
                                 baseTableName="teacher"
                                 baseColumnNames="teacher_hours_id"
                                 referencedTableName="teacher_hours"
                                 referencedColumnNames="id"/>
    </changeSet>
    <changeSet id="2023/02/08-2" author="dddd">
        <createView viewName="eas_vm" replaceIfExists="true">
            select `s`.`id`                  as `id`,
                   `s`.`semester`            as `csem`,
                   `s`.`course`              as `ccor`,
                   `d`.`name`                as `discipline_name`,
                   `s`.`group_names`         as `group_names`,
                   `s`.`lec_hours`           as `lec_hours`,
                   `s`.`lab_hours`           as `lab_hours`,
                   `t`.`name`                as `teacher_name`,
                   `s`.`pract_hours`         as `pract_hours`,
                   `s`.`note`                as `note`,
                   `s`.`number_of_subgroups` as `number_of_subgroups`,
                   `s`.`year`                as `year`
            from ((`discipline` `d`
                join `studyload_row` `s` on
                ((`d`.`id` = `s`.`discipline_id`)))
                join `teacher` `t` on
                ((`t`.`id` = `s`.`teacher_id`)))
            order by `d`.`name`,
                     char_length(`s`.`group_names`);
        </createView>
        <createView viewName="psl_vm" replaceIfExists="true">
            select `s`.`id`                               as `id`,
                   `s`.`year`                             as `year`,
                   `s`.`course`                           as `course`,
                   `s`.`semester`                         as `csem`,
                   `s`.`number_of_subgroups`              as `number_of_subgroups`,
                   `s`.`students_number`                  as `students_number`,
                   `s`.`group_names`                      as `group_names`,
                   `s`.`lec_hours`                        as `lec_hours`,
                   `s`.`consults_hours`                   as `consult_hours`,
                   `s`.`lab_hours`                        as `lab_hours`,
                   `s`.`pract_hours`                      as `pract_hours`,
                   `s`.`ind_task_hours`                   as `ind_task_hours`,
                   `s`.`cp_hours`                         as `cp_hours`,
                   `s`.`zalik_hours`                      as `zalik_hours`,
                   `s`.`exam_hours`                       as `exam_hours`,
                   `s`.`diploma_hours`                    as `diploma_hours`,
                   `s`.`dec_cell`                         as `dec_cell`,
                   `s`.`ndrs`                             as `ndrs`,
                   `s`.`practice`                         as `practice`,
                   `s`.`aspirant_hours`                   as `aspirant_hours`,
                   `f`.`department_full_name_genitive_case`   as `dep_name_gc`,
                   `f`.`department_full_name_nominative_case` as `dep_name_nc`,
                   `s`.`other_forms_hours`                as `other_forms_hours`,
                   `t`.`name`                             as `teacher_name`,
                   `d`.`name`                             as `discipline_name`,
                   `f`.`institute`                        as `institute`,
                   `t`.`nauk_stupin`                      as `nauk_stupin`,
                   `t`.`posada`                           as `posada`,
                   `t`.`vch_zvana`                        as `vch_zvana`,
                   `t`.`stavka`                           as `stavka`
            from (((`teacher` `t`
                join `studyload_row` `s` on
                (`t`.`id` = `s`.`teacher_id`))
                join `discipline` `d` on
                (`d`.`id` = `s`.`discipline_id`))
                join `formulary` `f` on
                (`f`.`id` = `s`.`formulary_id`))
                order by `d`.`name`,
                     char_length(`s`.`group_names`);
        </createView>
    </changeSet>

    <changeSet id="2023/02/11-1" author="dddd">
        <addColumn tableName="teacher_hours">
            <column name="psl_filename" type="varchar(255)"/>
        </addColumn>
    </changeSet>

</databaseChangeLog>